{% extends "app-base.html" %}

{% load staticfiles my_filters %}


{% block extrahead %}
  {{ block.super }}
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
  <link href="{% static "css/plugins/chosen/chosen.css" %}" rel="stylesheet">
{% endblock extrahead %}


{% block content %}
    <div class="row wrapper border-bottom white-bg page-heading">
        <div class="col-lg-10 m-t-md">
            <ol class="breadcrumb">
                <li>
                    <a href="{% url 'list_contacts' %}">Contacts</a>
                </li>
                <li class="active">
                    <strong>Workflow</strong>
                </li>
            </ol>
        </div>
    </div>
    <div class="col-xs-12 m-t-md">
        <select id="type-chooser">
            {% for type in stage_types %}
                <option value="{{type.0}}" {% if stage_type == type.0 %} selected="selected" {% endif %}>{{type.1}}</option>
            {% endfor %}
        </select>
    </div>
    <ul id="stages" class="col-xs-12 col-lg-6 m-t-md border-right padding-for-footer">
        <h3> Stages/Status </h3>
        {% for stage in stages %}
            <li id="stage-{{ stage.stage_id }}" class="col-xs-12 m-b-md m-l-md {{ stage.type }}" style="min-height: 30px;">
                <div id="{{ stage.stage_id }}" name="{{ stage.name }}" class="clickable {% if 'sundog.contact__edit_workflow' in perms %}edit-stage{% endif %}">
                    <span style="text-decoration: underline;">{{ stage.name }}</span>
                </div>
                <ul id="stage-{{ stage.stage_id }}-statuses" class="statuses col-xs-12 no-padding-sides">
                {% for status in stage.statuses.all %}
                    <li id="status-{{ status.status_id }}" class="status-row col-xs-12 no-padding-sides">
                        <div class="col-xs-6 inline m-r-md">
                            <div id="{{ status.status_id }}" name="{{ status.name }}" stage="{{ stage.stage_id }}" color="{{ status.color }}" class="clickable {% if 'sundog.contact__edit_workflow' in perms %}edit-status{% endif %}">
                                <span style="text-decoration: underline;">{{ status.name }}</span>
                            </div>
                        </div>
                        <div class="col-xs-6 inline m-r-md" style="background-color: {{ status.color }}; width: 200px; height:15px; border: 1px gray solid;"></div>
                    </li>
                {% endfor %}
                </ul>
            </li>
        {% endfor %}
    </ul>
    <div id="actions" class="col-xs-12 col-lg-6 padding-for-footer">
        <div class="col-xs-12 m-t-md border-bottom" style="padding-bottom: 15px;">
            <h3> Actions </h3>
            {% if 'sundog.contact__create_workflow' in perms %}
            <button id="add-stage-button" type="button" class="btn btn-primary">Add Stage</button>
            <button id="add-status-button" type="button" class="btn btn-primary" {% if not stages %} style="display: none;" {% endif %}>Add Status</button>
            {% endif %}
        </div>
        <div class="col-xs-12 m-t-md">
            <h3>Current Action: </h3>
            <div id="forms" class="col-xs-12 no-padding-sides padding-for-footer">
                {% if 'sundog.contact__create_workflow' in perms %}
                {% include "contact/partials/workflows/add_status_form.html" %}
                {% include "contact/partials/workflows/add_stage.form.html" %}
                {% endif %}
                {% if 'sundog.contact__edit_workflow' in perms %}
                {% include "contact/partials/workflows/edit_status_form.html" %}
                {% include "contact/partials/workflows/edit_stage.form.html" %}
                {% endif %}
            </div>
        </div>
    </div>
    <script src="{% static "js/contact/workflows.js" %}"></script>
    <script type="text/javascript">
        var csrfToken = '{{ csrf_token }}';
        var workflowUrl = '{% url 'workflows' %}';
        var updateStageOrderUrl = '{% url 'update_stage_order' %}';
        var updateStatusOrderUrl = '{% url 'update_status_order' %}';
        var deleteStageUrl = '{% url "delete_stage" stage_id=0 %}';
        var deleteStatusUrl = '{% url "delete_status" status_id=0 %}';
        $.ajaxSetup({
            data: {csrfmiddlewaretoken: csrfToken}
        });
    </script>
{% endblock content %}
