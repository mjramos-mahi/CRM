version: "2"

services:

  web:
    build:
      context: "."
    restart: "always"
    env_file: ".env"
    labels:
      # Django 1.10.3 disallows hostnames containing underscores as required
      # in RFC 1034.  By default, registrator names containerized services in
      # Consul using the name of the container image, which is generated by
      # Compose with an underscore between the project directory name and the
      # Compose service name.  To avoid this, set a static service name here.
      # This is unfortunate as running several instances of the project from
      # different directories in the same Docker host would require adjusting
      # this label manually, but at least the service works.
      SERVICE_NAME: "crm-web"
    links:
      - "postgres"
      - "elasticsearch"
      - "logstash"

  elasticsearch:
    build:
      context: "services/elasticsearch"
    restart: "always"
    volumes:
      - "./data/elasticsearch/data:/usr/share/elasticsearch/data"
      - "./data/elasticsearch/log:/usr/share/elasticsearch/log"

  logstash:
    build:
      context: "services/logstash"
    restart: "always"
    links:
      - "elasticsearch"

  kibana:
    build:
      context: "services/kibana"
    restart: "always"
    links:
      - "elasticsearch"

  postgres:
    image: "postgres:9.6"
    restart: "always"
    environment:
      POSTGRES_DB: "sundog_db"
      POSTGRES_USER: "sundog_db"
      POSTGRES_PASSWORD: "sundog_db"
    volumes:
      - "./data/postgres/data:/var/lib/postgresql/data"
      - "./data/postgres/log:/var/log/postgresql"
